name: ğŸ›ï¸ Deploy Widget-A (Alternative)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
  NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID_WIDGET_A }}
  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-24.04

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js v22.12.0
        uses: actions/setup-node@v5
        with:
          node-version: '22.12.0'
          registry-url: 'https://registry.npmjs.org'

      - name: ğŸ§ª Assert Node toolchain (hard fail if wrong)
        shell: bash
        run: |
          echo "PATH=$PATH"
          echo "node: $(which node)"
          echo "npm:  $(which npm)"
          node -v
          npm -v
          if [[ "$(node -v)" != "v22.12.0" ]]; then
            echo "âŒ Node is not v22.12.0. Failing."
            exit 1
          fi

      - name: ğŸ› ï¸ Install build tools for native modules
        shell: bash
        run: |
          echo "ğŸ› ï¸ Installing build essentials..."
          sudo apt-get update
          sudo apt-get install -y build-essential python3
          echo "âœ… Build tools installed"

      - name: ğŸ” Setup npm token
        shell: bash
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          echo "legacy-peer-deps=true" >> ~/.npmrc
          echo "auto-install-peers=true" >> ~/.npmrc
          npm whoami || true

      - name: ğŸ§¹ Clean installation for native modules
        shell: bash
        run: |
          echo "ğŸ§¹ Cleaning previous installations..."
          rm -rf node_modules package-lock.json
          npm cache clean --force
          echo "âœ… Clean completed"

      - name: ğŸ“š Install Dependencies
        shell: bash
        env:
          npm_config_platform: linux
          npm_config_arch: x64
          npm_config_python: python3
        run: |
          echo "ğŸ“¦ Installing dependencies for Linux x64..."
          npm install --legacy-peer-deps
          echo "ğŸ”§ Rebuilding native modules..."
          npm rebuild
          echo "âœ… Installation completed"

      - name: ğŸ”„ Use production federation config
        shell: bash
        run: |
          if [ -f "federation.config.multirepo.js" ]; then
            cp federation.config.multirepo.js federation.config.js
            echo "âœ… Production federation config applied"
          else
            echo "âš ï¸ federation.config.multirepo.js not found, using existing config"
          fi

      - name: ğŸ—ï¸ Build project
        shell: bash
        run: |
          echo "ğŸ” Available scripts:"
          npm run 2>&1 | grep -E "build:" || true

          if npm run build:multirepo; then
            echo "âœ… Widget-A built successfully with build:multirepo"
          elif npm run build:mfe-widget-a:prod; then
            echo "âœ… Widget-A built successfully with build:mfe-widget-a:prod"
          else
            echo "âŒ Build failed with all attempted scripts"
            exit 1
          fi

      - name: ğŸš€ Deploy to Netlify
        uses: netlify/actions/cli@master
        with:
          args: deploy --prod --dir=dist/mf-widget-a/browser --site=${{ secrets.NETLIFY_SITE_ID_WIDGET_A }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

      - name: ğŸ’¬ Comment on PR (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸš€ Widget A deployed successfully to Netlify!\\nğŸ”— URL: https://fractalia-widget-a.netlify.app\\nğŸ“¡ Remote Entry: https://fractalia-widget-a.netlify.app/remoteEntry.js'
            })
