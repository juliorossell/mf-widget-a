name: ðŸŽ›ï¸ Deploy Widget-A (Alternative)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
  NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID_WIDGET_A }}
  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-24.04

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js v22.12.0
        uses: actions/setup-node@v5
        with:
          node-version: '22.12.0'
          registry-url: 'https://registry.npmjs.org'

      - name: ðŸ§ª Assert Node toolchain (hard fail if wrong)
        shell: bash
        run: |
          echo "PATH=$PATH"
          echo "node: $(which node)"
          echo "npm:  $(which npm)"
          node -v
          npm -v
          if [[ "$(node -v)" != "v22.12.0" ]]; then
            echo "âŒ Node is not v22.12.0. Failing."
            exit 1
          fi

      - name: ðŸ› ï¸ Install build tools for native modules
        shell: bash
        run: |
          echo "ðŸ› ï¸ Installing build essentials..."
          sudo apt-get update
          sudo apt-get install -y build-essential python3
          echo "âœ… Build tools installed"

      - name: ðŸ” Setup npm token
        shell: bash
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          echo "legacy-peer-deps=true" >> ~/.npmrc
          echo "auto-install-peers=true" >> ~/.npmrc
          npm whoami || true

      - name: ðŸ§¹ Clean installation for native modules
        shell: bash
        run: |
          echo "ðŸ§¹ Cleaning previous installations..."
          rm -rf node_modules package-lock.json
          npm cache clean --force
          echo "âœ… Clean completed"

      - name: ðŸ“š Install Dependencies
        shell: bash
        env:
          npm_config_platform: linux
          npm_config_arch: x64
          npm_config_python: python3
        run: |
          echo "ðŸ“¦ Installing dependencies for Linux x64..."
          npm install --legacy-peer-deps
          echo "ðŸ”§ Rebuilding native modules..."
          npm rebuild
          echo "âœ… Installation completed"
          
          echo "ðŸ” Verifying key dependencies:"
          npm list @angular/core || echo "âš ï¸ @angular/core not found"
          npm list @angular/common || echo "âš ï¸ @angular/common not found"
          npm list rxjs || echo "âš ï¸ rxjs not found"

      - name: ðŸ”„ Use production federation config
        shell: bash
        run: |
          if [ -f "federation.config.multirepo.js" ]; then
            cp federation.config.multirepo.js federation.config.js
            echo "âœ… Production federation config applied"
          else
            echo "âš ï¸ federation.config.multirepo.js not found, using existing config"
          fi

      - name: ðŸ”§ Fix TypeScript Configuration Issues
        shell: bash
        run: |
          echo "ðŸ” Checking TypeScript configuration files..."
          
          # Verify tsconfig.json exists in root
          if [ ! -f "tsconfig.json" ]; then
            echo "âŒ tsconfig.json not found in root, checking if exists elsewhere..."
            find . -name "tsconfig.json" -type f | head -5
          else
            echo "âœ… tsconfig.json found in root"
          fi
          
          # Check tsconfig content for moduleResolution
          if [ -f "tsconfig.json" ]; then
            echo "ðŸ” Current tsconfig.json content:"
            cat tsconfig.json | head -20
          fi
          
          # Verify node_modules structure
          echo "ðŸ” Checking Angular modules installation:"
          ls -la node_modules/@angular/ 2>/dev/null | head -5 || echo "âš ï¸ @angular modules not found in node_modules"
          ls -la node_modules/rxjs/ 2>/dev/null | head -3 || echo "âš ï¸ rxjs not found in node_modules"
          
          # Check if native-federation is properly installed
          ls -la node_modules/@angular-architects/ 2>/dev/null || echo "âš ï¸ @angular-architects not found"
          
          # Verify that TypeScript can resolve modules
          echo "ðŸ” Testing TypeScript module resolution:"
          npx tsc --showConfig | head -10 || echo "âš ï¸ TypeScript config test failed"

      - name: ðŸ—ï¸ Build Widget-A for Production
        shell: bash
        run: |
          echo "ðŸ” Pre-build verification:"
          pwd
          
          echo "ðŸ” Working directory contents:"
          ls -la
          
          echo "ðŸ” Angular CLI version:"
          npx ng version || echo "âš ï¸ Angular CLI not working properly"
          
          echo "ðŸ” TypeScript version:"
          npx tsc --version || echo "âš ï¸ TypeScript not working"
          
          echo "ðŸ” Node and npm versions:"
          node -v
          npm -v
          
          echo "ðŸ” Checking critical files:"
          [ -f "angular.json" ] && echo "âœ… angular.json found" || echo "âŒ angular.json missing"
          [ -f "tsconfig.json" ] && echo "âœ… tsconfig.json found" || echo "âŒ tsconfig.json missing"
          [ -f "package.json" ] && echo "âœ… package.json found" || echo "âŒ package.json missing"
          
          echo "ðŸ—ï¸ Starting build process..."
          # Set NODE_OPTIONS to increase memory and handle potential issues
          export NODE_OPTIONS="--max-old-space-size=8192"
          
          # Try different build script names with better error handling
          if npm run build:mfa-widget-a:prod 2>&1; then
            echo "âœ… Widget-A built successfully with build:mfa-widget-a:prod"
          elif npm run build:multirepo 2>&1; then
            echo "âœ… Widget-A built successfully with build:multirepo"
          else
            echo "âŒ Build failed with all attempted scripts"
            echo "ðŸ” Detailed error investigation:"
            echo "ðŸ“‹ Available scripts:"
            npm run 2>&1
            echo "ðŸ” Angular projects:"
            npx ng generate --help 2>&1 | grep -A 20 "Available schematics" || true
            echo "ðŸ” TypeScript compilation test:"
            npx tsc --noEmit 2>&1 | head -20 || true
            exit 1
          fi
      - name: ðŸš€ Deploy to Netlify
        uses: netlify/actions/cli@master
        with:
          args: deploy --prod --dir=dist/mf-widget-a/browser --site=${{ secrets.NETLIFY_SITE_ID_WIDGET_A }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

      - name: ðŸ’¬ Comment on PR (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ Widget A deployed successfully to Netlify!\\nðŸ”— URL: https://fractalia-widget-a.netlify.app\\nðŸ“¡ Remote Entry: https://fractalia-widget-a.netlify.app/remoteEntry.js'
            })
